pipeline {
  agent {
    node {
      label "devops"
    }
  }
    stages {
        stage('checkout code ') {
            steps {
                checkoutgit branch: 'main', credentialsId: '5bb7bb1c-1c6f-434f-b432-045296bdf8a1', url: 'https://github.com/rutukeshkoli/usermgmt.git'
            }
        }
        stage('docker build') {
            steps {
                script {
                    sh '''
                        cd userproj
                        docker build -t rutukesh/usermgmtback:v0.0.$BUILD_ID . --no-cache'''
                }
            }
        }
        stage('pushing image to registry') {
            steps {
                script {
                    sh ''' docker push rutukesh/usermgmtback:v0.0.$BUILD_ID 
                           docker rmi  rutukesh/usermgmtback:v0.0.$BUILD_ID '''
                }
            }
        }
        stage('deploy app') {
            steps {
                script {
                    sh ''' 
                    cd  userproj
                    kubectl config use-context DEV
                    kubectl apply -f deployment.yaml
                    kubectl set image deployment/usermgmtback usermgmtback=kk2104/usermgmtback:v0.0.$BUILD_ID  -n userapp --record=true'''
                    
                }
            }
        }
        stage('clean workspace') {
            steps {
                cleanWs()
            }
        }
    }
}
